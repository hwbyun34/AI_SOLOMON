import { NextResponse } from "next/server";

export async function POST(req: Request) {
  try {
    const { text } = await req.json();

    if (!text || text.trim().length === 0) {
      return NextResponse.json(
        { error: "ë¶„ìŸ ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤." },
        { status: 400 }
      );
    }

    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) {
      return NextResponse.json(
        { error: "OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." },
        { status: 500 }
      );
    }

    /**
     * âœ… ì˜ë„ ë¶„ë¦¬í˜• AI íŒ¨ë„ 10ëª…
     * - ê°ê´€ 5
     * - ê°ì • 1
     * - ë„ë• 1
     * - ì¼ë°˜ ì¸ì‹ 1
     * - êµ¬ì¡°/ì¬ë°œ 1
     * - ê· í˜• ì¤‘ë¦½ 1
     */
    const panelStyles = [
      "ì‚¬ì‹¤ê´€ê³„ ì •í•©ì„± ë¶„ì„ íŒ¨ë„",
      "ì¦ê±° ì‹ ë¢°ë„ ë° ê·¼ê±° ì¶©ì¡±ì„± í‰ê°€ íŒ¨ë„",
      "ë…¼ë¦¬ êµ¬ì¡° ì¼ê´€ì„± ê²€ì¦ íŒ¨ë„",
      "ë¶„ìŸ ë°œìƒì˜ í•µâ€‹ì‹¬ ì›ì¸ ì œê³µ ë¶„ì„ íŒ¨ë„",
      "ì œ3ì ê´€ì  ì‚¬ì‹¤ íŒë‹¨ íŒ¨ë„",
      "ê°ì • ë°˜ì‘ ë° ì‹¬ë¦¬ ì˜í–¥ ë¶„ì„ íŒ¨ë„",
      "ì‚¬íšŒì  ì±…ì„ ë° ë„ë• ê·œë²” ê´€ì  íŒ¨ë„",
      "ì¼ë°˜ì¸ ì¸ì‹ ë° ìƒì‹ ê¸°ì¤€ íŒë‹¨ íŒ¨ë„",
      "ê°ˆë“± ì í™” ë° í™•ëŒ€ í–‰ìœ„ ë¶„ì„ íŒ¨ë„",
      "ê°ê´€Â·ì¤‘ë¦½ ì¢…í•© íŒë‹¨ íŒ¨ë„",
    ];

    const messages = [
      {
        role: "system",
        content: `
ë‹¹ì‹ ì€ ë¶„ìŸ ë¶„ì„ ì „ë¬¸ê°€ AIì…ë‹ˆë‹¤.

ë°˜ë“œì‹œ ë‹¤ìŒ ì ˆì°¨ë¥¼ ë”°ë¥´ì‹­ì‹œì˜¤:

âš ï¸ íŒë‹¨ ê°•ì œ ê·œì¹™
- ëª¨ë“  íŒ¨ë„ì€ ë°˜ë“œì‹œ ì…ì¥ 1 ë˜ëŠ” ì…ì¥ 2 ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.
- íŒë‹¨ ê·¼ê±°ê°€ ì•½í•˜ë”ë¼ë„, ìƒëŒ€ì  ì±…ì„Â·ì˜í–¥Â·ë¶ˆë¦¬í•¨ì„ ê¸°ì¤€ìœ¼ë¡œ ìš°ì„¸ íŒë‹¨ì„ ë‚´ë ¤ì•¼ í•©ë‹ˆë‹¤.
- "ì–‘ì¸¡ ëª¨ë‘", "íŒë‹¨ì´ ì–´ë µë‹¤", "ì¤‘ë¦½ì ì´ë‹¤"ì™€ ê°™ì€ í‘œí˜„ì€ ê¸ˆì§€ë©ë‹ˆë‹¤.

1. ì‚¬ê±´ì„ ë°”íƒ•ìœ¼ë¡œ "ì…ì¥ 1"ê³¼ "ì…ì¥ 2"ë¥¼ ë‚´ë¶€ì ìœ¼ë¡œ êµ¬ì¡°í™”í•©ë‹ˆë‹¤.
2. ì•„ë˜ì— ì£¼ì–´ì§„ íŒ¨ë„ ì„±í–¥ì„ ë°˜ë“œì‹œ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
3. ê° íŒ¨ë„ì€ ìì‹ ì˜ ì„±í–¥ì—ë§Œ ì¶©ì‹¤í•˜ê²Œ íŒë‹¨í•©ë‹ˆë‹¤.

ê° íŒ¨ë„ì€ ë‹¤ìŒ 2ê°€ì§€ë§Œ ì‘ì„±í•©ë‹ˆë‹¤:
- íŒë‹¨ ë°©í–¥: "ì…ì¥ 1 ìš°ì„¸" / "ì…ì¥ 2 ìš°ì„¸"
- íŒë‹¨ ì‚¬ìœ : 1~2ë¬¸ì¥, ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ

âš ï¸ ì¤‘ìš” ê·œì¹™
- ì‚¬ê±´ ë‚´ìš©ì„ ê¸¸ê²Œ ë°˜ë³µí•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
- ê°ì • íŒ¨ë„ì€ ê°ì • ê´€ì ë§Œ, ë„ë• íŒ¨ë„ì€ ë„ë• ê´€ì ë§Œ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
- ì¶œë ¥ì€ ë°˜ë“œì‹œ JSONë§Œ í—ˆìš©ë©ë‹ˆë‹¤.
- ì½”ë“œë¸”ë¡, ì„¤ëª… ë¬¸ì¥, ì—¬ë¶„ í…ìŠ¤íŠ¸ ì ˆëŒ€ ê¸ˆì§€.
        `,
      },
      {
        role: "user",
        content: `
ë‹¤ìŒ ë¶„ìŸì„ ë¶„ì„í•˜ì„¸ìš”:

"${text}"

ì•„ë˜ íŒ¨ë„ ì„±í–¥ì„ ìˆœì„œëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ ì´ 10ëª…ì˜ íŒë‹¨ì„ ìƒì„±í•˜ì„¸ìš”:

${panelStyles.map((s, i) => `${i + 1}. ${s}`).join("\n")}

ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ ë™ì¼):

{
  "summary": "ì‚¬ê±´ì˜ í•µì‹¬ì„ 3~4ì¤„ë¡œ ìš”ì•½",
  "panels": [
    {
      "panel": "AI Panel #1",
      "style": "íŒ¨ë„ ì„±í–¥",
      "side": "ì…ì¥ 1 ìš°ì„¸ / ì…ì¥ 2 ìš°ì„¸ / ì¤‘ë¦½",
      "reason": "íŒë‹¨ ì‚¬ìœ "
    }
  ]
}
        `,
      },
    ];

    const response = await fetch(
      "https://api.openai.com/v1/chat/completions",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages,
          temperature: 0.4, // ğŸ”¥ ììœ ë¶„ë°©í•¨ ì–µì œ
        }),
      }
    );

    const result = await response.json();
    const raw = result.choices?.[0]?.message?.content;

    if (!raw) {
      return NextResponse.json(
        { error: "AI ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤." },
        { status: 500 }
      );
    }

    let json;
    try {
      json = JSON.parse(raw);
    } catch {
      const cleaned = raw.replace(/```json|```/g, "").trim();
      json = JSON.parse(cleaned);
    }

    return NextResponse.json(json);
  } catch (error) {
    console.error("API ERROR:", error);
    return NextResponse.json(
      { error: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." },
      { status: 500 }
    );
  }
}
