import { NextResponse } from "next/server";

export async function POST(req: Request) {
  try {
    const { text } = await req.json();

    if (!text || text.trim().length === 0) {
      return NextResponse.json(
        { error: "ë¶„ìŸ ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤." },
        { status: 400 }
      );
    }

    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) {
      return NextResponse.json(
        { error: "OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." },
        { status: 500 }
      );
    }

    /**
     * âœ… ì˜ë„ ë¶„ë¦¬í˜• AI íŒ¨ë„ 10ëª…
     * - ê°ê´€ 5
     * - ê°ì • 1
     * - ë„ë• 1
     * - ì¼ë°˜ ì¸ì‹ 1
     * - êµ¬ì¡°/ì¬ë°œ 1
     * - ê· í˜• ì¤‘ë¦½ 1
     */
    const panelStyles = [
      "ì‚¬ì‹¤ê´€ê³„ ì •í•©ì„± ë¶„ì„ íŒ¨ë„",
      "ì¦ê±° ì‹ ë¢°ë„ ë° ê·¼ê±° ì¶©ì¡±ì„± í‰ê°€ íŒ¨ë„",
      "ë…¼ë¦¬ êµ¬ì¡° ì¼ê´€ì„± ê²€ì¦ íŒ¨ë„",
      "ë¶„ìŸ ë°œìƒì˜ í•µâ€‹ì‹¬ ì›ì¸ ì œê³µ ë¶„ì„ íŒ¨ë„",
      "ì œ3ì ê´€ì  ì‚¬ì‹¤ íŒë‹¨ íŒ¨ë„",
      "ê°ì • ë°˜ì‘ ë° ì‹¬ë¦¬ ì˜í–¥ ë¶„ì„ íŒ¨ë„",
      "ì‚¬íšŒì  ì±…ì„ ë° ë„ë• ê·œë²” ê´€ì  íŒ¨ë„",
      "ì¼ë°˜ì¸ ì¸ì‹ ë° ìƒì‹ ê¸°ì¤€ íŒë‹¨ íŒ¨ë„",
      "ê°ˆë“± ì í™” ë° í™•ëŒ€ í–‰ìœ„ ë¶„ì„ íŒ¨ë„",
      "ê°ê´€Â·ì¤‘ë¦½ ì¢…í•© íŒë‹¨ íŒ¨ë„",
    ];

    const messages = [
      {
        role: "system",
        content: `
ë‹¹ì‹ ì€ ë¶„ìŸ ë¶„ì„ ì „ë¬¸ê°€ AIì…ë‹ˆë‹¤.

ë°˜ë“œì‹œ ë‹¤ìŒ ì ˆì°¨ë¥¼ ë”°ë¥´ì‹­ì‹œì˜¤:

âš ï¸ íŒë‹¨ ê°•ì œ ê·œì¹™
- ëª¨ë“  íŒ¨ë„ì€ ë°˜ë“œì‹œ ì…ì¥ 1 ë˜ëŠ” ì…ì¥ 2 ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.
- íŒë‹¨ ê·¼ê±°ê°€ ì•½í•˜ë”ë¼ë„, ìƒëŒ€ì  ì±…ì„Â·ì˜í–¥Â·ë¶ˆë¦¬í•¨ì„ ê¸°ì¤€ìœ¼ë¡œ ìš°ì„¸ íŒë‹¨ì„ ë‚´ë ¤ì•¼ í•©ë‹ˆë‹¤.
- "ì–‘ì¸¡ ëª¨ë‘", "íŒë‹¨ì´ ì–´ë µë‹¤", "ì¤‘ë¦½ì ì´ë‹¤"ì™€ ê°™ì€ í‘œí˜„ì€ ê¸ˆì§€ë©ë‹ˆë‹¤.

1. ì‚¬ê±´ì„ ë°”íƒ•ìœ¼ë¡œ "ì…ì¥ 1"ê³¼ "ì…ì¥ 2"ë¥¼ ë‚´ë¶€ì ìœ¼ë¡œ êµ¬ì¡°í™”í•©ë‹ˆë‹¤.
2. ì•„ë˜ì— ì£¼ì–´ì§„ íŒ¨ë„ ì„±í–¥ì„ ë°˜ë“œì‹œ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
3. ê° íŒ¨ë„ì€ ìì‹ ì˜ ì„±í–¥ì—ë§Œ ì¶©ì‹¤í•˜ê²Œ íŒë‹¨í•©ë‹ˆë‹¤.

âš ï¸ ì…ì¥ ë²ˆí˜¸ ê³ ì • ê·œì¹™:
- ì…ì¥ 1ì€ ì‚¬ìš©ìê°€ ì„œìˆ ì—ì„œ ë¨¼ì € ì„¤ëª…í•œ ë‹¹ì‚¬ìì˜ ì…ì¥ì…ë‹ˆë‹¤.
- ì…ì¥ 2ëŠ” ê·¸ì— ëŒ€ì‘í•˜ëŠ” ìƒëŒ€ë°©ì˜ ì…ì¥ì…ë‹ˆë‹¤.
- íŒë‹¨ ê²°ê³¼ì™€ ë¬´ê´€í•˜ê²Œ ì…ì¥ ë²ˆí˜¸ë¥¼ ì¬ì •ì˜í•˜ê±°ë‚˜ ë°”ê¾¸ì§€ ë§ˆì‹­ì‹œì˜¤.

ê° íŒ¨ë„ì€ ë‹¤ìŒ 2ê°€ì§€ë§Œ ì‘ì„±í•©ë‹ˆë‹¤:
- íŒë‹¨ ë°©í–¥: "ì…ì¥ 1 ìš°ì„¸" / "ì…ì¥ 2 ìš°ì„¸"
- íŒë‹¨ ì‚¬ìœ : 1~2ë¬¸ì¥, ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ

âš ï¸ ì¤‘ìš” ê·œì¹™
- ì‚¬ê±´ ë‚´ìš©ì„ ê¸¸ê²Œ ë°˜ë³µí•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
- ê°ì • íŒ¨ë„ì€ ê°ì • ê´€ì ë§Œ, ë„ë• íŒ¨ë„ì€ ë„ë• ê´€ì ë§Œ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
- ì¶œë ¥ì€ ë°˜ë“œì‹œ JSONë§Œ í—ˆìš©ë©ë‹ˆë‹¤.
- ì½”ë“œë¸”ë¡, ì„¤ëª… ë¬¸ì¥, ì—¬ë¶„ í…ìŠ¤íŠ¸ ì ˆëŒ€ ê¸ˆì§€.

ğŸ“Œ ì¶”ê°€ ì¶œë ¥ ìš”êµ¬ (ê¸°ì¡´ ì¶œë ¥ ìœ ì§€)

- panels ì¶œë ¥ê³¼ ë³„ë„ë¡œ, ë¶„ìŸ ë‹¹ì‚¬ì ì…ì¥ì„ 1ì¸ì¹­ ì‹œì ìœ¼ë¡œ ê°ê° ìš”ì•½í•˜ì‹­ì‹œì˜¤.
- ê³µê²©ì Â·ë¹„ë‚œ ë§íˆ¬ ê¸ˆì§€, ì„¤ëª…í˜• ë¬¸ì¥ ì‚¬ìš©
- êµ¬ì¡°:
  1) ìƒëŒ€ì˜ í–‰ë™ ì¸ì‹
  2) ê·¸ë¡œ ì¸í•´ ë‚´ê°€ ëŠë‚€ ê°ì •/ìƒê°
  3) ê·¸ ê²°ê³¼ ë‚´ê°€ ì·¨í•œ í–‰ë™
- ê° ì…ì¥ì€ 2~3ë¬¸ì¥ ì´ë‚´

JSONì— ë°˜ë“œì‹œ ì•„ë˜ í•„ë“œë¥¼ ì¶”ê°€í•˜ì‹­ì‹œì˜¤:

"positions": {
  "position1": "ì…ì¥ 1ì˜ 1ì¸ì¹­ ìš”ì•½",
  "position2": "ì…ì¥ 2ì˜ 1ì¸ì¹­ ìš”ì•½"
}

âš ï¸ ë¹„ë¶„ìŸ ì˜ˆì™¸ ê·œì¹™ì´ ì ìš©ë˜ëŠ” ê²½ìš°:
- positionsì˜ ë‘ ê°’ì€ ëª¨ë‘ "í•´ë‹¹ ì—†ìŒ"ìœ¼ë¡œ ì¶œë ¥í•˜ì‹­ì‹œì˜¤.

âš ï¸ ì…ì¥ ê³ ì • ê·œì¹™ (ë§¤ìš° ì¤‘ìš”)
- ì…ì¥ 1ì€ í•­ìƒ ë¶„ìŸì„ ì œê¸°í•œ ì‚¬ëŒ(ë¬¸ì œë¥¼ ì œê¸°í•œ ë‹¹ì‚¬ì)ì´ë‹¤.
- ì…ì¥ 2ëŠ” í•´ë‹¹ ë¬¸ì œì— ëŒ€ì‘í•œ ì‚¬ëŒì´ë‹¤.

âš ï¸ ë¶„ìŸ íŒë³„ ì˜ˆì™¸ ê·œì¹™ (ë§¤ìš° ì¤‘ìš”)
- ì…ë ¥ëœ ë‚´ìš©ì— ì•„ë˜ ìš”ì†Œê°€ í•˜ë‚˜ë„ í¬í•¨ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ
  ì˜ˆì™¸ ê·œì¹™ì„ ì ìš©í•˜ì‹­ì‹œì˜¤:

  1. ë‘ ëª… ì´ìƒì˜ í–‰ìœ„ì ë˜ëŠ” ë‹¹ì‚¬ì
  2. ë¶ˆë§Œ, ë¹„ë‚œ, ì±…ì„ ì „ê°€, ì„œìš´í•¨, ì–µìš¸í•¨ ë“± ê°ˆë“± ì‹ í˜¸
  3. í–‰ë™ ë˜ëŠ” ì„ íƒì— ëŒ€í•œ í‰ê°€ ê°€ëŠ¥ì„±
  4. ê´€ê³„ ì•…í™”, ë‹¤íˆ¼, ì˜¤í•´, ì¶©ëŒì´ ë°œìƒí–ˆê±°ë‚˜ ë°œìƒ ê°€ëŠ¥í•œ ìƒí™©

- ìœ„ ìš”ì†Œ ì¤‘ í•˜ë‚˜ë¼ë„ ì¡´ì¬í•œë‹¤ë©´,
  í•´ë‹¹ ì‚¬ê±´ì€ ë¶„ìŸìœ¼ë¡œ ê°„ì£¼í•˜ê³ 
  ë°˜ë“œì‹œ ê¸°ì¡´ íŒë‹¨ ì ˆì°¨ë¥¼ ìˆ˜í–‰í•˜ì‹­ì‹œì˜¤.

- ì˜ˆì™¸ ê·œì¹™ì´ ì ìš©ë˜ëŠ” ê²½ìš°ì—ë§Œ
  ì•„ë˜ JSONì„ ê·¸ëŒ€ë¡œ ì¶œë ¥í•˜ê³ ,
  ë‹¤ë¥¸ íŒë‹¨ì€ ì ˆëŒ€ ìˆ˜í–‰í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.

âš ï¸ ì¶”ê°€ ì¶œë ¥ ê·œì¹™
- ê¸°ì¡´ summary, panels êµ¬ì¡°ëŠ” ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
- ì•„ë˜ í•­ëª©ì„ ë°˜ë“œì‹œ ì¶”ê°€í•˜ì‹­ì‹œì˜¤.

"positions": {
  "position1": "ì…ì¥ 1ì„ 1ì¸ì¹­ìœ¼ë¡œ ìš”ì•½ (ìƒëŒ€ í–‰ë™ â†’ ë‚´ ê°ì • â†’ ë‚´ í–‰ë™)",
  "position2": "ì…ì¥ 2ë¥¼ 1ì¸ì¹­ìœ¼ë¡œ ìš”ì•½ (ìƒëŒ€ í–‰ë™ â†’ ë‚´ ê°ì • â†’ ë‚´ í–‰ë™)"
}

- ë°˜ë“œì‹œ 1ì¸ì¹­ í™”ë²•ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.
- ê³µê²©Â·ë¹„ë‚œ í‘œí˜„ ê¸ˆì§€
- ê° 2~3ë¬¸ì¥ ì´ë‚´

{
  "summary": "ë³¸ ì…ë ¥ì€ ë¶„ìŸ ìƒí™©ìœ¼ë¡œ íŒë‹¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.",
  "panels": [
    { "panel": "AI Panel #1", "style": "ë¹„ë¶„ìŸ íŒë³„", "side": "ì¤‘ë¦½", "reason": "ë¶„ìŸ ìš”ì†Œ ì—†ìŒ" },
    { "panel": "AI Panel #2", "style": "ë¹„ë¶„ìŸ íŒë³„", "side": "ì¤‘ë¦½", "reason": "íŒë‹¨ ëŒ€ìƒ ë¶€ì¬" },
    { "panel": "AI Panel #3", "style": "ë¹„ë¶„ìŸ íŒë³„", "side": "ì¤‘ë¦½", "reason": "ê°ˆë“± êµ¬ì¡° ì—†ìŒ" },
    { "panel": "AI Panel #4", "style": "ë¹„ë¶„ìŸ íŒë³„", "side": "ì¤‘ë¦½", "reason": "ì±…ì„ ë¹„êµ ë¶ˆê°€" },
    { "panel": "AI Panel #5", "style": "ë¹„ë¶„ìŸ íŒë³„", "side": "ì¤‘ë¦½", "reason": "ëŒ€ë¦½ ê´€ê³„ ì—†ìŒ" },
    { "panel": "AI Panel #6", "style": "ë¹„ë¶„ìŸ íŒë³„", "side": "ì¤‘ë¦½", "reason": "ê°ì • ì¶©ëŒ ì—†ìŒ" },
    { "panel": "AI Panel #7", "style": "ë¹„ë¶„ìŸ íŒë³„", "side": "ì¤‘ë¦½", "reason": "ë„ë• íŒë‹¨ ë¶ˆí•„ìš”" },
    { "panel": "AI Panel #8", "style": "ë¹„ë¶„ìŸ íŒë³„", "side": "ì¤‘ë¦½", "reason": "ìƒì‹ì  íŒë‹¨ ëŒ€ìƒ ì•„ë‹˜" },
    { "panel": "AI Panel #9", "style": "ë¹„ë¶„ìŸ íŒë³„", "side": "ì¤‘ë¦½", "reason": "ê°ˆë“± ì í™” ìš”ì†Œ ì—†ìŒ" },
    { "panel": "AI Panel #10", "style": "ë¹„ë¶„ìŸ íŒë³„", "side": "ì¤‘ë¦½", "reason": "ì¢…í•© íŒë‹¨ ë¶ˆê°€" }
  ]
}
        `,
      },
      {
        role: "user",
        content: `
ë‹¤ìŒ ë¶„ìŸì„ ë¶„ì„í•˜ì„¸ìš”:

"${text}"

ì•„ë˜ íŒ¨ë„ ì„±í–¥ì„ ìˆœì„œëŒ€ë¡œ ì‚¬ìš©í•˜ì—¬ ì´ 10ëª…ì˜ íŒë‹¨ì„ ìƒì„±í•˜ì„¸ìš”:

${panelStyles.map((s, i) => `${i + 1}. ${s}`).join("\n")}

ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ ë™ì¼):

{
  "summary": "ì‚¬ê±´ì˜ í•µì‹¬ì„ 3~4ì¤„ë¡œ ìš”ì•½",
  "positions": {
  "position1": "ë„ˆì˜ â—‹â—‹í•œ í–‰ë™ ë•Œë¬¸ì— ë‚˜ëŠ” â–³â–³ë¼ê³  ëŠê¼ˆê³ , ê·¸ë˜ì„œ ì´ë ‡ê²Œ í–‰ë™í–ˆì–´.",
  "position2": "ë‚˜ë„ ë„¤ í–‰ë™ì„ ì´ë ‡ê²Œ ë°›ì•„ë“¤ì˜€ê³ , ê·¸ë¡œ ì¸í•´ ì´ëŸ° ì„ íƒì„ í•˜ê²Œ ëì–´."
  },
  "panels": [
    {
      "panel": "AI Panel #1",
      "style": "íŒ¨ë„ ì„±í–¥",
      "side": "ì…ì¥ 1 ìš°ì„¸ / ì…ì¥ 2 ìš°ì„¸ / ì¤‘ë¦½",
      "reason": "íŒë‹¨ ì‚¬ìœ "
    }
  ]
}
        `,
      },
    ];

    const response = await fetch(
      "https://api.openai.com/v1/chat/completions",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`,
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages,
          temperature: 0.4, // ğŸ”¥ ììœ ë¶„ë°©í•¨ ì–µì œ
        }),
      }
    );

    const result = await response.json();
    const raw = result.choices?.[0]?.message?.content;

    if (!raw) {
      return NextResponse.json(
        { error: "AI ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤." },
        { status: 500 }
      );
    }

    let json;
    try {
      json = JSON.parse(raw);
    } catch {
      const cleaned = raw.replace(/```json|```/g, "").trim();
      json = JSON.parse(cleaned);
    }

    return NextResponse.json(json);
  } catch (error) {
    console.error("API ERROR:", error);
    return NextResponse.json(
      { error: "ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." },
      { status: 500 }
    );
  }
}
